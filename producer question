一.基于emqx实现mqtt通讯的代理项目
  功能：消费设备上报的rocketmq数据，对所有数据进行mqtt转发出去
  背景：v4版本的项目已经在稳定运行，由于业务需要，做了一个功能类似的v5版本，同时发布到一台宿主机上
  问题：v5项目已启动，马上oom
  分析过程：
  1：使用jmap histo pid > 1.txt查看内存使用情况，发现rocket中clientExtend以及监听的consumerService有十几万个，通过分析源码，找到所有的消息只要出现异常，全部会往一个无界的阻塞队列里面放
  ，这样的话，会导致数据量大，消费不过来的情况，内存会爆掉。由于rocktmq中没有提供设置队列大小的入口。所以通过classloader加载原理，复制了一份类，修改队列大小为1000，不会导致oom
  2：修改后发现不会oom了，但是TPS非常低，和v4同项目相比差距很大。于是打印出来了耗时，判断出调用mqtt的push发送消息耗时太久导致的。于是检查mqtt客户端push源码，发现并不存在问题
  ，然后maxflight也没有达到上限，于是线索从这里断开了。当然也是因为有其它事情要做，所以暂时放一放了。
  3：第二天重新检查了一下，确定就是mqtt的push耗时太久。于是使用emqx提供的后台命令tarce跟踪clientid的消息和ack情况。发现耗时都是很正常的，这下束手无策了。然后仔细回想了一下
  ，v4和v5项目的相同点和不同点，突然灵光一闪，觉得有可能是服务器带宽不够，都在一台服务器上导致的。沟通运维分开部署v5后，发现tps持续上升最终稳定了。
  4：最后到腾讯云上查看了网络带宽进行了24小时的情况，发现果然问题就是出现在这里。
因为也是一次线上排错经验，所以想着积累下来先，大家可以参考
  
